#!/bin/sh

if [ "$#" -lt 3 ]
then
	printf "usage: $0 run arch [docker args]\n"
	exit 1
fi

if [ $1 != "run" ]
then
	printf "first argument must be run\n"
	exit 1
fi

shift

ARCH=$1

shift

if [ ! -f /tmp/qemu-static ]
then
	mkdir /tmp/qemu-static
	(cd /tmp/qemu-static && docker run justincormack/debian-qemu-user tarup.sh | tar xf -)
fi

if [ ! -f /tmp/qemu-static/qemu-$ARCH-static ]
then
	printf "architecture $ARCH not found\n"
	exit 1
fi

docker info | grep -q 'Server Version: 1.10' && EXTRA_ARGS="--security-opt seccomp:unconfined"

docker run -v /tmp/qemu-static/qemu-$ARCH-static:/usr/bin/qemu-$ARCH-static $EXTRA_ARGS $*
